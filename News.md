Reed Emmons라는 사람이 리드 개발자였다고 하고, 백본이나 커피스크립트를 만든  Jeremy Ashkenas가 그 회사에서 일한다고 하네요... 리드개발자가 직접 설명한 글이 http://open.blogs.nytimes.com/2014/01/08/the-technology-behind-the-nytimes-com-redesign/?_php=true&_type=blogs&_r=1&에 있어서 간단하게 번역해 봤습니다(풀 번역은 아니고 중간중간 구절을 빼먹은 부분도 있습니다). 귀찮아서 약간의 보그체를 씁니다.

저작권문제가 있을수도 있으니 참고로만 쓰세용...

# NYTimes.com 재설계 뒤에 있는 기술

(Reed Emmons)

NYTimes.com같은 사이트를 바닥부터 다시 만드는 일은 드물다. 모양을 바꾸는 것 말고, 전체 플랫폼을 다시 만드는 것 말이다. 2006년 NYTimes.com의 외양은 변경되었지만, 마지막으로 인프라가 바뀐건 새천년이 시작될 때정도로 거슬러 올라가야만 한다. 새로운 제품과 설계, 뉴스팀의 요구에 맞추기 위해 클라이언트와 서버쪽 아키텍쳐를 모두 다 다시 만들었다. 기존 코드의 일부는 리팩토링해 재사용했지만, 대부분의 코드는 참조로만 쓰이고 제거되었다.

## 정적인 페이지를 퍼블리시하기: 역사적인 교훈

오늘까지 NY TImes의 컨텐츠는 데이터센터 하드드라이브에 있는 정적인 HTML 페이지로 되어 있었다. 렌더링 시스템은 편집부서에서 글을 웹에 출간하기로 결정하면 HTML 파일을 하드에 기록했다. 내부적인 HTML 틀이 있어서 필요한 부분을 채워넣도록 되어 있었다. 기사에 대한 요청(웹 요청)이 오면 런타임에 미리 렌더링된 템플릿과 광고가 페이지에 주입되어 제공된다. 이런 과정은 충분히 빨랐기 때문에 굳이 다른 방식을 택할 필요가 없었다.

예전 방식을 사용하는 것은 동적인 능력이 제약된다는 단점이 있다. HTML은 고정되어있지만, 스타일시트는 동적이기 때문에, 프론트엔드팀에서는 지금까지 만들어진 모든 템플릿 버전을 유지보수 해야 했다. 이로인해 2년전의 글과 몇 주 전의 글의 외양이 약간 달라진다. 하위호환되는 CSS를 먼저 조심스레 런칭하고, 모든 브라우저 캐시가 클리어될 때까지 기다려서 변경된 자바스크립트를 런칭하는게 일반적인 방식이 되었다.

관심있는 사람은 이 프로젝트의 프론트엔드 아키텍트인 Eitan Konigsburg가 작년에 발표한 내용을 살펴보라(http://www.youtube.com/watch?v=2dwBB2Xa_B0)

## 더 스마트한 레이아웃

더 스마트한 디자인을 돕기 위해 자체 반응형 자바스크립트 엔진을 만들었다. 이를 통해 CSS 미디어 쿼리 없이도 다양한 디자인 변화 지점(breakpoint)를 지원할 수 있게 되었다. 새 엔진은 특정 변화 지점의 HTML 태그에 뷰포트 클래스를 토글함으로써 반응형 디자인을 가능케한다. [LESS](http://lesscss.org/)가 엔진 기능과 어우러져서 쉽게 유지보수 가능하며 대부분의 브라우저에서 잘 지원되는 우아한 코드를 사용할 수 있게 되었다. 기사 페이지는 브라우저나 디바이스 크기에 따라 20여 단계로 조정이 된다. 예를 들어 다음 LESS 코드는 우리 페이지의 뷰포트 클래스를 사용하고 있다.

```

.ribbon {
   ...
   // responsive
   // 1020
   .viewport-medium-50 & {
      .offset(0, 1, 0, left);
    }

   // 1200
   .viewport-large-20 & {
      .offset(0, 2, 0, left);
   }
}

```

새 프레이워크는 변화지점을 지원함과 더불어 장치 타입이나 방향, 크기, 광고 성격 등에 따라 주요 소식(lede)의 미디어 타입이나 레이아웃을 결정할 수 있다. 변화지점등을 고려한다면 기사 페이지는 100가지 정도의 변형이 생길 수 있다.

## 자바스크립트에 구조를 추가하기

동적이고 개인화된 기능을 지원하기 위해 자바스크립트를 많이 사용해야만 했다. 모듈 사이의 타이트한 커플링을 제거하기 위해 튼튼한 프레임워크가 필요했다. [백본](http://backbonejs.org/)과 [리콰이어](http://requirejs.org/)가 구조와 표준적인 코드 작성법을 제공했다. 백본은 적당히 유연하면서도 다른 프레임워크보다 덜 독단적이어서 선택되었다. [제이쿼리](http://jquery.com/), [모더나이저](http://modernizr.com/), [SockJS](http://sockjs.org), [언더스코어](http://underscorejs.org/"), [해머](http://eightmedia.github.io/hammer.js/) 등이 지원 라이브러리로 사용된다. 또한 [모카](http://visionmedia.github.io/mocha/)와 [차이](http://chaijs.com/)를 활용해 테스트 커버리지를 넓혔다.

프레임워크 개발에 사용한 기법으로는 :

1. [백본 믹스인]()을 사용해 코드 중복을 제거
2. 모든 백본 뷰를 기반 뷰에서 확장함
3. 스크롤이나 리사이징 같은 비싼 이벤트를 [쓰로틀링](http://underscorejs.org/#throttle) 하거나 [튕겨냄](http://underscorejs.org/#debounce)

## 새로운 PHP  렌더링 프레임워크

다이나믹 플랫폼으로 변경하려니 새로운 엔진이 필요했다. 기존 PHP 프레임워크가 좋은 기반이 되겠지만 새로 만들기로 했다. 다양한 컨텐츠를 제공하면서 유연성을 더 제공할 수 있도록 만들었다. 이로 인해 우리 프레임워크는 한 페이지에 대해 여러 레이아웃과 여러 설정을 동적으로 렌더링할 수 있게 되었다.

새 프레임워크를 사용하면 강력한 애플래키이션을 코드 몇 줄로 작성할 수 있다. 애플리케이션 개발은 기존 콤포넌트를 서로 이어붙이는 것으로 거의 가능하며 그에 따라 개발 시간도 줄어들었다. 추가로 사용 가능한 모듈의 라이브러리를 단순하고 깔끔하게 만들어서 코드 중복을 피하면서 제공되는 기능으로부터 이익을 얻도록 했다.

## 서버측 캐시를 통해 속도 향상시키기

동적으로 서비스를 하므로 리버스 프록시를 통해 PHP 프레임워크에 과부하가 걸리는 것을 피할 필요가 있다. 작년에 바니시(Vanish)를 성공적으로 런치하면서 자신감을 축적했다. 바니시는 필요에 따라 설정을 바꿀 수 있으면서도 광속으로 컨텐츠 요청에 응답할 수 있다. 바니시를 사용해 자주 바뀌는 기사들도 캐시에 좀 더 빨리 저장되도록 할 수 있었다.

## 빌드 과정과 프론트엔드 성능

[그런트](http://gruntjs.com/)를 사용해 코드를 최적화했다. 기사 페이지에서는 동기화되어 다운로드되는 최적화된 스크립트와 CSS 파일이 3개 사용된다. 과거의 기사에서는 대충 80개정도의 파일이 최적화되지 않은채로 HEAD에서 쓰였다. 페이지의 맨 끝에 리콰이어를 사용해 프론트엔드 렌더링을 담당하는 빌드 파일들을 비동기적으로 로딩한다. 쿠키가 없는 CDN과 1년 유효기간 캐시 헤더를 사용해 독자들이 필요한 파일을 재 다운로드 받는 것을 최소화했다. 바니시와 함께 사용하면 모든 페이지가 500~1000 밀리초 안에 DOMContentLoaded를 받을 수 있다.

모든 스크립트 태그가 블록킹이기 때문에, 광고를 비동기적으로 로딩할 수 있으면 성능 향상을 크게 가져올 수 있다. 광고는 document.write가 포함되는 것으로 악명이 높기 때문에, 코드를 DOM에 바로 넣으면 페이지 컨텐트를 다시 써버릴 수가 있다. 이를 막기 위해 모든 광고는 iFrame에 넣어서 DOMContentLoaded가 발생하면 추가된다.

이런 빌드 과정으로 프론트엔드 프레임워크에서 또 다른 마술이 가능하다. 모든 아이콘을 "sprite-me" 폴더에 넣고, 커스텀화된 그런트 태스크가 스프라이트 시트와 컴파일된 이미지의 좌표를 제공하는 LESS 믹스인 파일을 익스포트하도록 했다. 마지막으로 언더스코어를 사용해 HTML 템플릿을 미리 컴파일해서 모듈이 쉽게 요청하고, 브라우저에서 렌더링할 수 있게 했다.

##  마치면서

오늘, 새 플랫폼은 새로 발행된 기사와 상호작용하는 기능들로 구성되어 있다. 새 프레임워크로 인해 더 빨리 이터레이션 할 수 있고, 연속적인 딜리버리라는 우리 목표에 더 가까와질 수 있다. 기술 부체를 모두 갚은것은 아니지만, 다양한 기술 수준의 개발자들이 코드기반에 기여할 수 있는 튼튼한 기술 플랫폼을 만들었다고 생각한다. 

다음에는 팀 멤버중 한명에 웹소켓서부터 PHP 프레임워크까지 우리 시스템을 만드는데 사용된 기반 기술에 대해 더 자세히 파 볼 것이다.

